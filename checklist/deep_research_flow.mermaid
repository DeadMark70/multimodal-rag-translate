sequenceDiagram
    autonumber
    participant User as 使用者 (Frontend)
    participant API as Router (API Layer)
    participant Service as DeepResearchService
    participant Planner as Planner Agent
    participant RAG as RAG Service
    participant VectorDB as Vector/Graph Store
    participant Vision as Vision Tool (Re-Act)
    participant Evaluator as Evaluator Agent
    participant Synthesizer as Synthesizer Agent

    Note over User, Service: 參數: enable_deep_image_analysis=True

    User->>API: POST /rag/execute (Plan)
    API->>Service: execute_plan()
    
    %% Phase 1: Initial Execution
    Service->>RAG: 1. 執行初始子任務
    RAG->>VectorDB: 檢索文檔 (Vector + Graph)
    VectorDB-->>RAG: 返回 Chunks + 圖片摘要
    
    %% Phase 9: Visual Verification (Re-Act Loop)
    rect rgb(240, 248, 255)
        Note right of RAG: Phase 9: 視覺查證迴圈
        RAG->>RAG: 生成初步回答 (LLM)
        alt LLM 請求 "VERIFY_IMAGE"
            RAG->>Vision: verify_image_details(path, question)
            Vision->>Vision: re_examine_image (Gemini Vision)
            Vision-->>RAG: 返回詳細視覺分析
            RAG->>RAG: 綜合新資訊生成答案
        end
    end
    
    RAG-->>Service: 返回 Result (Answer + Sources)

    %% Phase 2: Drill-down Loop
    loop Drill-down Iterations (遞迴深入)
        Service->>Planner: 2. 檢查知識缺口 (Create Follow-up)
        Planner-->>Service: 返回新任務列表 (Follow-up Tasks)
        
        loop 執行新任務 (Smart Retry)
            Service->>RAG: 執行查詢
            RAG-->>Service: 返回 Answer
            
            %% Phase 4/6: Evaluation & Smart Retry
            Service->>Evaluator: 3. 評估回答品質
            Evaluator-->>Service: Score (1-10) + Reason
            
            alt Score < 6.0 (品質不佳)
                Service->>Planner: 請求優化查詢 (refine_query)
                Planner-->>Service: 返回 Refined Query
                Service->>RAG: 使用新查詢重試 (Retry)
                RAG-->>Service: 返回新 Answer
            end
        end
    end

    %% Phase 3: Synthesis
    Service->>Synthesizer: 4. 綜合最終報告
    Note right of Synthesizer: 使用學術模板 + 圖片引用
    Synthesizer-->>Service: Final Markdown Report
    Service-->>API: ExecutePlanResponse
    API-->>User: 顯示報告與圖表