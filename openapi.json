{
  "openapi": "3.1.0",
  "info": {
    "title": "PDF Translation & RAG API",
    "description": "PDF OCR, Translation, and Multimodal RAG services",
    "version": "2.1.0"
  },
  "paths": {
    "/pdfmd/list": {
      "get": {
        "tags": [
          "PDF OCR & Translation"
        ],
        "summary": "List Documents",
        "description": "Lists all documents uploaded by the user.\n\nReturns documents ordered by upload time (newest first).\nLimited to 50 documents maximum.\n\nArgs:\n    user_id: Authenticated user ID (injected).\n\nReturns:\n    Dict containing documents list and total count.\n\nRaises:\n    HTTPException: 500 if database query fails.",
        "operationId": "list_documents_pdfmd_list_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "additionalProperties": true,
                  "type": "object",
                  "title": "Response List Documents Pdfmd List Get"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/pdfmd/upload_pdf_md": {
      "post": {
        "tags": [
          "PDF OCR & Translation"
        ],
        "summary": "Upload Pdf Md",
        "description": "Uploads a PDF, runs OCR/translation/PDF generation, and starts background indexing.\n\nPipeline:\n1. Save uploaded PDF\n2. OCR extraction (PaddleOCR - CPU bound, runs in threadpool)\n3. Add to RAG knowledge base\n4. Translate to Traditional Chinese (Gemini API)\n5. Generate translated PDF\n6. Return JSON status with doc_id and PDF availability\n\nArgs:\n    file: The uploaded PDF file.\n    user_id: Authenticated user ID.\n\nReturns:\n    UploadPdfResponse with processing status and download availability.\n\nRaises:\n    HTTPException: 400 for invalid input, 500 for processing errors.",
        "operationId": "upload_pdf_md_pdfmd_upload_pdf_md_post",
        "requestBody": {
          "content": {
            "multipart/form-data": {
              "schema": {
                "$ref": "#/components/schemas/Body_upload_pdf_md_pdfmd_upload_pdf_md_post"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UploadPdfResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/pdfmd/ocr": {
      "post": {
        "tags": [
          "PDF OCR & Translation"
        ],
        "summary": "Upload Pdf Md",
        "description": "Uploads a PDF, runs OCR/translation/PDF generation, and starts background indexing.\n\nPipeline:\n1. Save uploaded PDF\n2. OCR extraction (PaddleOCR - CPU bound, runs in threadpool)\n3. Add to RAG knowledge base\n4. Translate to Traditional Chinese (Gemini API)\n5. Generate translated PDF\n6. Return JSON status with doc_id and PDF availability\n\nArgs:\n    file: The uploaded PDF file.\n    user_id: Authenticated user ID.\n\nReturns:\n    UploadPdfResponse with processing status and download availability.\n\nRaises:\n    HTTPException: 400 for invalid input, 500 for processing errors.",
        "operationId": "upload_pdf_md_pdfmd_ocr_post",
        "requestBody": {
          "content": {
            "multipart/form-data": {
              "schema": {
                "$ref": "#/components/schemas/Body_upload_pdf_md_pdfmd_ocr_post"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UploadPdfResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/pdfmd/file/{doc_id}/status": {
      "get": {
        "tags": [
          "PDF OCR & Translation"
        ],
        "summary": "Get Processing Status",
        "description": "Returns the current processing status of a document.\n\nAllows frontend to poll for progress updates during upload.\n\nArgs:\n    doc_id: Document UUID.\n    user_id: Authenticated user ID.\n\nReturns:\n    Dict with step info:\n    - step: Current processing step code\n    - step_label: Human-readable step label (Chinese)\n    - is_pdf_ready: True if translated PDF is available\n    - is_fully_complete: True if all processing (including RAG) is done",
        "operationId": "get_processing_status_pdfmd_file__doc_id__status_get",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "doc_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Doc Id"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true,
                  "title": "Response Get Processing Status Pdfmd File  Doc Id  Status Get"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/pdfmd/file/{doc_id}": {
      "get": {
        "tags": [
          "PDF OCR & Translation"
        ],
        "summary": "Get Pdf File",
        "description": "Retrieves a processed PDF file by document ID.\n\nArgs:\n    doc_id: Document UUID.\n    user_id: Authenticated user ID.\n\nReturns:\n    FileResponse with the PDF file.\n\nRaises:\n    HTTPException: 404 if document not found.",
        "operationId": "get_pdf_file_pdfmd_file__doc_id__get",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "doc_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Doc Id"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {}
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": [
          "PDF OCR & Translation"
        ],
        "summary": "Delete Pdf File",
        "description": "Deletes a document and all associated files.\n\nCleanup steps:\n1. Remove from FAISS vector index\n2. Delete physical files\n3. Remove database record\n\nArgs:\n    doc_id: Document UUID.\n    user_id: Authenticated user ID.\n\nReturns:\n    Success status dict.\n\nRaises:\n    HTTPException: 500 if database deletion fails.",
        "operationId": "delete_pdf_file_pdfmd_file__doc_id__delete",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "doc_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Doc Id"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true,
                  "title": "Response Delete Pdf File Pdfmd File  Doc Id  Delete"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/pdfmd/file/{doc_id}/summary": {
      "get": {
        "tags": [
          "PDF OCR & Translation"
        ],
        "summary": "Get Document Summary Endpoint",
        "description": "Retrieves the executive summary for a document.\n\nArgs:\n    doc_id: Document UUID.\n    user_id: Authenticated user ID.\n\nReturns:\n    Dict with summary content and status.\n    - status: \"ready\" | \"generating\" | \"not_available\"\n    - summary: The executive summary text (null if not ready)",
        "operationId": "get_document_summary_endpoint_pdfmd_file__doc_id__summary_get",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "doc_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Doc Id"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true,
                  "title": "Response Get Document Summary Endpoint Pdfmd File  Doc Id  Summary Get"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/pdfmd/file/{doc_id}/summary/regenerate": {
      "post": {
        "tags": [
          "PDF OCR & Translation"
        ],
        "summary": "Regenerate Summary Endpoint",
        "description": "Triggers regeneration of the executive summary.\n\nRetrieves the document's original text content and schedules\na new background summary generation task.\n\nArgs:\n    doc_id: Document UUID.\n    user_id: Authenticated user ID.\n\nReturns:\n    Status indicating regeneration has started.",
        "operationId": "regenerate_summary_endpoint_pdfmd_file__doc_id__summary_regenerate_post",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "doc_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Doc Id"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true,
                  "title": "Response Regenerate Summary Endpoint Pdfmd File  Doc Id  Summary Regenerate Post"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/rag/ask": {
      "post": {
        "tags": [
          "RAG Question Answering"
        ],
        "summary": "Ask Question With Context",
        "description": "Context-aware question answering with conversation history.\n\nThis enhanced endpoint supports:\n- Conversation history for multi-turn dialogue\n- Advanced retrieval options (HyDE, Multi-Query)\n- Document filtering\n- Optional Self-RAG evaluation (enable_evaluation=True)\n\nWhen enable_evaluation=True, returns EnhancedAskResponse with:\n- Detailed source citations (page, snippet, score)\n- Responsibility metrics (faithfulness, confidence)\n\nArgs:\n    request: AskRequest with question, history, and options.\n    background_tasks: FastAPI BackgroundTasks for async logging.\n    user_id: Authenticated user ID (injected).\n\nReturns:\n    EnhancedAskResponse.\n\nRaises:\n    HTTPException: 400 if history too long, 500 if answering fails.",
        "operationId": "ask_question_with_context_rag_ask_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AskRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EnhancedAskResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/rag/research": {
      "post": {
        "tags": [
          "RAG Question Answering"
        ],
        "summary": "Research Question",
        "description": "Performs deep research on a complex question using Plan-and-Solve.\n\nThis endpoint:\n1. Decomposes the question into sub-tasks\n2. Runs RAG on each sub-task\n3. Synthesizes results into a research report\n\nArgs:\n    request: Research request with question and options.\n    user_id: Authenticated user ID (injected).\n\nReturns:\n    ResearchResponse with summary, detailed answer, and sub-task results.\n\nRaises:\n    HTTPException: 500 if research fails.",
        "operationId": "research_question_rag_research_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ResearchRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ResearchResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/rag/plan": {
      "post": {
        "tags": [
          "RAG Question Answering"
        ],
        "summary": "Generate Research Plan",
        "description": "Generates a research plan for user confirmation.\n\nThis is the first phase of interactive deep research.\nReturns a list of sub-tasks that the user can review, modify,\nor remove before execution.\n\nArgs:\n    request: Research plan request with question and options.\n    user_id: Authenticated user ID (injected).\n    \nReturns:\n    ResearchPlanResponse with editable sub-tasks.\n    \nRaises:\n    HTTPException: 500 if planning fails.",
        "operationId": "generate_research_plan_rag_plan_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ResearchPlanRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ResearchPlanResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/rag/execute": {
      "post": {
        "tags": [
          "RAG Question Answering"
        ],
        "summary": "Execute Research Plan",
        "description": "Executes a user-confirmed research plan with drill-down.\n\nThis is the second phase of interactive deep research.\nRuns the confirmed sub-tasks, identifies knowledge gaps,\nand performs recursive drill-down up to max_iterations.\n\nArgs:\n    request: Confirmed execution request with sub-tasks.\n    user_id: Authenticated user ID (injected).\n    \nReturns:\n    ExecutePlanResponse with complete research results.\n    \nRaises:\n    HTTPException: 400 if no tasks provided, 500 if execution fails.",
        "operationId": "execute_research_plan_rag_execute_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ExecutePlanRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ExecutePlanResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/rag/execute/stream": {
      "post": {
        "tags": [
          "RAG Question Answering"
        ],
        "summary": "Execute Research Plan Stream",
        "description": "Executes research plan with SSE streaming progress updates.\n\nThis endpoint uses Server-Sent Events (SSE) to stream real-time\nprogress updates during deep research execution.\n\nEvent types:\n- plan_confirmed: Research started\n- task_start: Sub-task execution started\n- task_done: Sub-task completed\n- drilldown_start: Drill-down iteration started\n- drilldown_task_start: Drill-down task started\n- drilldown_task_done: Drill-down task completed\n- synthesis_start: Final synthesis started\n- complete: Research complete (includes full response)\n- error: Error occurred\n\nArgs:\n    request: Confirmed execution request with sub-tasks.\n    user_id: Authenticated user ID (injected).\n    \nReturns:\n    EventSourceResponse with SSE stream.\n    \nRaises:\n    HTTPException: 400 if no tasks provided.",
        "operationId": "execute_research_plan_stream_rag_execute_stream_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ExecutePlanRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {}
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/imagemd/translate_image": {
      "post": {
        "tags": [
          "Image Translation"
        ],
        "summary": "Translate Image Inplace",
        "description": "Translates text in an image and returns the modified image.\n\nPipeline:\n1. Read and validate image\n2. Perform OCR to detect text regions\n3. Translate detected text to Traditional Chinese\n4. Draw translated text back onto image\n5. Return modified image\n\nArgs:\n    file: The uploaded image file.\n    user_id: Authenticated user ID (injected).\n\nReturns:\n    Response with the translated image as JPEG.\n\nRaises:\n    HTTPException: 400 for invalid input, 500 for processing errors.",
        "operationId": "translate_image_inplace_imagemd_translate_image_post",
        "requestBody": {
          "content": {
            "multipart/form-data": {
              "schema": {
                "$ref": "#/components/schemas/Body_translate_image_inplace_imagemd_translate_image_post"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {}
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/multimodal/extract": {
      "post": {
        "tags": [
          "Multimodal Research"
        ],
        "summary": "Extract From Pdf Endpoint",
        "description": "Extracts text and visual elements from a PDF, summarizes images, and indexes content.\n\nPipeline:\n1. Phase 1: Extract text chunks and visual elements (PaddleOCR)\n2. Phase 2: Summarize visual elements (Gemini)\n3. Phase 3: Index all content to FAISS\n\nArgs:\n    file: The uploaded PDF file.\n    user_id: Authenticated user ID (injected via dependency).\n\nReturns:\n    ExtractedDocument containing text chunks and visual elements with summaries.\n\nRaises:\n    HTTPException: 400 for invalid input, 500 for processing errors.",
        "operationId": "extract_from_pdf_endpoint_multimodal_extract_post",
        "requestBody": {
          "content": {
            "multipart/form-data": {
              "schema": {
                "$ref": "#/components/schemas/Body_extract_from_pdf_endpoint_multimodal_extract_post"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ExtractedDocument"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/multimodal/file/{doc_id}": {
      "delete": {
        "tags": [
          "Multimodal Research"
        ],
        "summary": "Delete Multimodal Document",
        "description": "Deletes a multimodal document and all associated files.\n\nCleanup steps:\n1. Remove from FAISS vector index (text chunks + visual summaries)\n2. Delete physical files (original PDF + cropped images)\n\nArgs:\n    doc_id: Document UUID.\n    user_id: Authenticated user ID.\n\nReturns:\n    Success status dict.",
        "operationId": "delete_multimodal_document_multimodal_file__doc_id__delete",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "doc_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Doc Id"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true,
                  "title": "Response Delete Multimodal Document Multimodal File  Doc Id  Delete"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/stats/dashboard": {
      "get": {
        "tags": [
          "Dashboard Statistics"
        ],
        "summary": "Get Dashboard Stats",
        "description": "Returns dashboard statistics for the user.\n\nAggregates query_logs data to provide:\n- Total query count\n- Accuracy metrics (grounded/hallucinated rates)\n- 7-day query trend\n- Most queried documents\n\nArgs:\n    user_id: Authenticated user ID (injected).\n\nReturns:\n    DashboardStats with analytics data.\n\nRaises:\n    HTTPException: 500 if database query fails.",
        "operationId": "get_dashboard_stats_stats_dashboard_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DashboardStats"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/graph/status": {
      "get": {
        "tags": [
          "Knowledge Graph"
        ],
        "summary": "取得圖譜狀態",
        "description": "取得使用者知識圖譜的狀態資訊，包括節點數、邊數、社群數等。",
        "operationId": "get_graph_status_graph_status_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GraphStatusResponse"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/graph/data": {
      "get": {
        "tags": [
          "Knowledge Graph"
        ],
        "summary": "取得視覺化資料",
        "description": "取得 react-force-graph 格式的圖譜資料，用於前端視覺化。",
        "operationId": "get_graph_visualization_data_graph_data_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GraphVisualizationData"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/graph/rebuild": {
      "post": {
        "tags": [
          "Knowledge Graph"
        ],
        "summary": "重建圖譜",
        "description": "強制重建使用者的知識圖譜。會重新從所有文件中抽取實體與關係。",
        "operationId": "rebuild_graph_graph_rebuild_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/GraphRebuildRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GraphOperationResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/graph/optimize": {
      "post": {
        "tags": [
          "Knowledge Graph"
        ],
        "summary": "優化圖譜",
        "description": "執行實體融合與社群重建，合併相似的實體節點。",
        "operationId": "optimize_graph_graph_optimize_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/GraphOptimizeRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GraphOperationResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/api/conversations": {
      "get": {
        "tags": [
          "Conversations"
        ],
        "summary": "List Conversations",
        "description": "Lists all conversations for the authenticated user.\n\nReturns conversations ordered by updated_at descending (most recent first).\n\nArgs:\n    user_id: Authenticated user ID (injected).\n    \nReturns:\n    List of ConversationResponse.\n    \nRaises:\n    HTTPException: 500 if database query fails.",
        "operationId": "list_conversations_api_conversations_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "items": {
                    "$ref": "#/components/schemas/ConversationResponse"
                  },
                  "type": "array",
                  "title": "Response List Conversations Api Conversations Get"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      },
      "post": {
        "tags": [
          "Conversations"
        ],
        "summary": "Create Conversation",
        "description": "Creates a new conversation.\n\nArgs:\n    data: Conversation creation data.\n    user_id: Authenticated user ID (injected).\n    \nReturns:\n    Created ConversationResponse.\n    \nRaises:\n    HTTPException: 500 if creation fails.",
        "operationId": "create_conversation_api_conversations_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ConversationCreate"
              }
            }
          },
          "required": true
        },
        "responses": {
          "201": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ConversationResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/api/conversations/{conversation_id}": {
      "get": {
        "tags": [
          "Conversations"
        ],
        "summary": "Get Conversation",
        "description": "Gets a conversation with all its messages.\n\nArgs:\n    conversation_id: Conversation UUID.\n    user_id: Authenticated user ID (injected).\n    \nReturns:\n    ConversationDetailResponse with messages.\n    \nRaises:\n    HTTPException: 404 if not found, 500 if query fails.",
        "operationId": "get_conversation_api_conversations__conversation_id__get",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "conversation_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Conversation Id"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ConversationDetailResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      },
      "patch": {
        "tags": [
          "Conversations"
        ],
        "summary": "Update Conversation",
        "description": "Updates a conversation's title or metadata.\n\nArgs:\n    conversation_id: Conversation UUID.\n    data: Update data.\n    user_id: Authenticated user ID (injected).\n    \nReturns:\n    Updated ConversationResponse.\n    \nRaises:\n    HTTPException: 404 if not found, 500 if update fails.",
        "operationId": "update_conversation_api_conversations__conversation_id__patch",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "conversation_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Conversation Id"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ConversationUpdate"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ConversationResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": [
          "Conversations"
        ],
        "summary": "Delete Conversation",
        "description": "Deletes a conversation and all its messages.\n\nMessages are deleted via CASCADE foreign key constraint.\n\nArgs:\n    conversation_id: Conversation UUID.\n    user_id: Authenticated user ID (injected).\n    \nRaises:\n    HTTPException: 404 if not found, 500 if delete fails.",
        "operationId": "delete_conversation_api_conversations__conversation_id__delete",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "conversation_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Conversation Id"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Successful Response"
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/api/conversations/{conversation_id}/messages": {
      "post": {
        "tags": [
          "Conversations"
        ],
        "summary": "Create Message",
        "description": "Adds a message to a conversation.\n\nArgs:\n    conversation_id: Conversation UUID.\n    data: Message content and role.\n    user_id: Authenticated user ID (injected).\n    \nReturns:\n    Created ChatMessageResponse.\n    \nRaises:\n    HTTPException: 404 if conversation not found, 500 if insert fails.",
        "operationId": "create_message_api_conversations__conversation_id__messages_post",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "conversation_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Conversation Id"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/MessageCreate"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ChatMessageResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/": {
      "get": {
        "summary": "Read Root",
        "description": "Health check endpoint.",
        "operationId": "read_root__get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "additionalProperties": {
                    "type": "string"
                  },
                  "type": "object",
                  "title": "Response Read Root  Get"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "AskRequest": {
        "properties": {
          "question": {
            "type": "string",
            "maxLength": 2000,
            "minLength": 1,
            "title": "Question",
            "description": "使用者問題"
          },
          "doc_ids": {
            "anyOf": [
              {
                "items": {
                  "type": "string"
                },
                "type": "array"
              },
              {
                "type": "null"
              }
            ],
            "title": "Doc Ids",
            "description": "限定查詢的文件 ID 列表（留空則查詢全部文件）"
          },
          "history": {
            "anyOf": [
              {
                "items": {
                  "$ref": "#/components/schemas/ChatMessage"
                },
                "type": "array"
              },
              {
                "type": "null"
              }
            ],
            "title": "History",
            "description": "對話歷史（最多 10 條，用於上下文感知對話）"
          },
          "enable_hyde": {
            "type": "boolean",
            "title": "Enable Hyde",
            "description": "啟用 HyDE 假設性文件增強檢索",
            "default": false
          },
          "enable_multi_query": {
            "type": "boolean",
            "title": "Enable Multi Query",
            "description": "啟用多重查詢融合檢索",
            "default": false
          },
          "enable_reranking": {
            "type": "boolean",
            "title": "Enable Reranking",
            "description": "啟用 Cross-Encoder 重排序（建議開啟）",
            "default": true
          },
          "enable_evaluation": {
            "type": "boolean",
            "title": "Enable Evaluation",
            "description": "啟用 Self-RAG 評估模式（會增加延遲）",
            "default": false
          },
          "enable_graph_rag": {
            "type": "boolean",
            "title": "Enable Graph Rag",
            "description": "啟用知識圖譜增強檢索",
            "default": false
          },
          "graph_search_mode": {
            "type": "string",
            "enum": [
              "local",
              "global",
              "hybrid",
              "auto"
            ],
            "title": "Graph Search Mode",
            "description": "圖譜搜尋模式: local (實體擴展), global (社群摘要), hybrid (兩者), auto (自動判斷)",
            "default": "auto"
          },
          "enable_graph_planning": {
            "type": "boolean",
            "title": "Enable Graph Planning",
            "description": "啟用圖譜輔助規劃 (Deep Research 時使用)",
            "default": false
          }
        },
        "type": "object",
        "required": [
          "question"
        ],
        "title": "AskRequest",
        "description": "Request body for POST /ask endpoint.\n\nAttributes:\n    question: The user's question.\n    doc_ids: Optional list of document IDs to filter retrieval.\n    history: Optional conversation history for context-aware responses.\n    enable_hyde: Enable HyDE (Hypothetical Document Embeddings) retrieval.\n    enable_multi_query: Enable multi-query fusion retrieval.\n    enable_reranking: Enable Cross-Encoder reranking (recommended).\n    enable_evaluation: Enable Self-RAG evaluation (adds latency).\n    enable_graph_rag: Enable knowledge graph enhanced retrieval.\n    graph_search_mode: Graph search mode (local/global/hybrid/auto).\n    enable_graph_planning: Enable graph-based planning for Deep Research."
      },
      "Body_extract_from_pdf_endpoint_multimodal_extract_post": {
        "properties": {
          "file": {
            "type": "string",
            "format": "binary",
            "title": "File"
          }
        },
        "type": "object",
        "required": [
          "file"
        ],
        "title": "Body_extract_from_pdf_endpoint_multimodal_extract_post"
      },
      "Body_translate_image_inplace_imagemd_translate_image_post": {
        "properties": {
          "file": {
            "type": "string",
            "format": "binary",
            "title": "File"
          }
        },
        "type": "object",
        "required": [
          "file"
        ],
        "title": "Body_translate_image_inplace_imagemd_translate_image_post"
      },
      "Body_upload_pdf_md_pdfmd_ocr_post": {
        "properties": {
          "file": {
            "type": "string",
            "format": "binary",
            "title": "File"
          }
        },
        "type": "object",
        "required": [
          "file"
        ],
        "title": "Body_upload_pdf_md_pdfmd_ocr_post"
      },
      "Body_upload_pdf_md_pdfmd_upload_pdf_md_post": {
        "properties": {
          "file": {
            "type": "string",
            "format": "binary",
            "title": "File"
          }
        },
        "type": "object",
        "required": [
          "file"
        ],
        "title": "Body_upload_pdf_md_pdfmd_upload_pdf_md_post"
      },
      "ChatMessage": {
        "properties": {
          "role": {
            "$ref": "#/components/schemas/MessageRole"
          },
          "content": {
            "type": "string",
            "title": "Content"
          }
        },
        "type": "object",
        "required": [
          "role",
          "content"
        ],
        "title": "ChatMessage",
        "description": "A single message in conversation history.\n\nAttributes:\n    role: The role of the message sender (user or assistant).\n    content: The message content."
      },
      "ChatMessageResponse": {
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "title": "Id"
          },
          "role": {
            "type": "string",
            "enum": [
              "user",
              "assistant",
              "system"
            ],
            "title": "Role"
          },
          "content": {
            "type": "string",
            "title": "Content"
          },
          "metadata": {
            "anyOf": [
              {
                "additionalProperties": true,
                "type": "object"
              },
              {
                "type": "null"
              }
            ],
            "title": "Metadata"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "title": "Created At"
          }
        },
        "type": "object",
        "required": [
          "id",
          "role",
          "content",
          "created_at"
        ],
        "title": "ChatMessageResponse",
        "description": "Response model for a single chat message.\n\nAttributes:\n    id: Message ID.\n    role: Message role ('user' or 'assistant' or 'system').\n    content: Message content.\n    metadata: Optional metadata.\n    created_at: Message timestamp."
      },
      "ConversationCreate": {
        "properties": {
          "title": {
            "anyOf": [
              {
                "type": "string",
                "maxLength": 200
              },
              {
                "type": "null"
              }
            ],
            "title": "Title",
            "default": "新對話"
          },
          "type": {
            "type": "string",
            "enum": [
              "chat",
              "research"
            ],
            "title": "Type",
            "default": "chat"
          },
          "metadata": {
            "anyOf": [
              {
                "additionalProperties": true,
                "type": "object"
              },
              {
                "type": "null"
              }
            ],
            "title": "Metadata"
          }
        },
        "type": "object",
        "title": "ConversationCreate",
        "description": "Request model for creating a new conversation.\n\nAttributes:\n    title: Conversation title (default: \"新對話\").\n    type: Conversation type - 'chat' or 'research'."
      },
      "ConversationDetailResponse": {
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "title": "Id"
          },
          "title": {
            "type": "string",
            "title": "Title"
          },
          "type": {
            "type": "string",
            "enum": [
              "chat",
              "research"
            ],
            "title": "Type"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "title": "Created At"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "title": "Updated At"
          },
          "metadata": {
            "anyOf": [
              {
                "additionalProperties": true,
                "type": "object"
              },
              {
                "type": "null"
              }
            ],
            "title": "Metadata"
          },
          "messages": {
            "items": {
              "$ref": "#/components/schemas/ChatMessageResponse"
            },
            "type": "array",
            "title": "Messages"
          }
        },
        "type": "object",
        "required": [
          "id",
          "title",
          "type",
          "created_at",
          "updated_at"
        ],
        "title": "ConversationDetailResponse",
        "description": "Response model for conversation with messages.\n\nExtends ConversationResponse with a list of messages.\n\nAttributes:\n    messages: List of chat messages in chronological order."
      },
      "ConversationResponse": {
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "title": "Id"
          },
          "title": {
            "type": "string",
            "title": "Title"
          },
          "type": {
            "type": "string",
            "enum": [
              "chat",
              "research"
            ],
            "title": "Type"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "title": "Created At"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "title": "Updated At"
          },
          "metadata": {
            "anyOf": [
              {
                "additionalProperties": true,
                "type": "object"
              },
              {
                "type": "null"
              }
            ],
            "title": "Metadata"
          }
        },
        "type": "object",
        "required": [
          "id",
          "title",
          "type",
          "created_at",
          "updated_at"
        ],
        "title": "ConversationResponse",
        "description": "Response model for conversation basic info.\n\nAttributes:\n    id: Unique conversation ID.\n    title: Conversation title.\n    type: Conversation type.\n    created_at: Creation timestamp.\n    updated_at: Last update timestamp.\n    metadata: Optional metadata."
      },
      "ConversationUpdate": {
        "properties": {
          "title": {
            "type": "string",
            "maxLength": 200,
            "minLength": 1,
            "title": "Title"
          },
          "metadata": {
            "anyOf": [
              {
                "additionalProperties": true,
                "type": "object"
              },
              {
                "type": "null"
              }
            ],
            "title": "Metadata"
          }
        },
        "type": "object",
        "required": [
          "title"
        ],
        "title": "ConversationUpdate",
        "description": "Request model for updating a conversation.\n\nAttributes:\n    title: New conversation title."
      },
      "DashboardStats": {
        "properties": {
          "total_queries": {
            "type": "integer",
            "title": "Total Queries"
          },
          "accuracy_rate": {
            "type": "number",
            "title": "Accuracy Rate"
          },
          "grounded_count": {
            "type": "integer",
            "title": "Grounded Count"
          },
          "hallucinated_count": {
            "type": "integer",
            "title": "Hallucinated Count"
          },
          "uncertain_count": {
            "type": "integer",
            "title": "Uncertain Count"
          },
          "avg_confidence": {
            "type": "number",
            "title": "Avg Confidence"
          },
          "queries_last_7_days": {
            "items": {
              "type": "integer"
            },
            "type": "array",
            "title": "Queries Last 7 Days"
          },
          "top_documents": {
            "items": {
              "$ref": "#/components/schemas/DocumentStat"
            },
            "type": "array",
            "title": "Top Documents"
          }
        },
        "type": "object",
        "required": [
          "total_queries",
          "accuracy_rate",
          "grounded_count",
          "hallucinated_count",
          "uncertain_count",
          "avg_confidence",
          "queries_last_7_days",
          "top_documents"
        ],
        "title": "DashboardStats",
        "description": "Dashboard statistics response model."
      },
      "DocumentStat": {
        "properties": {
          "doc_id": {
            "type": "string",
            "title": "Doc Id"
          },
          "filename": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Filename"
          },
          "query_count": {
            "type": "integer",
            "title": "Query Count"
          }
        },
        "type": "object",
        "required": [
          "doc_id",
          "query_count"
        ],
        "title": "DocumentStat",
        "description": "Document usage statistics."
      },
      "EditableSubTask": {
        "properties": {
          "id": {
            "type": "integer",
            "title": "Id"
          },
          "question": {
            "type": "string",
            "title": "Question"
          },
          "task_type": {
            "type": "string",
            "enum": [
              "rag",
              "graph_analysis"
            ],
            "title": "Task Type",
            "default": "rag"
          },
          "enabled": {
            "type": "boolean",
            "title": "Enabled",
            "default": true
          }
        },
        "type": "object",
        "required": [
          "id",
          "question"
        ],
        "title": "EditableSubTask",
        "description": "A user-editable sub-task in the research plan.\n\nAttributes:\n    id: Unique task identifier.\n    question: The sub-question to research.\n    task_type: Query method - 'rag' for vector search, 'graph_analysis' for graph.\n    enabled: Whether this task is enabled (user can toggle)."
      },
      "EnhancedAskResponse": {
        "properties": {
          "question": {
            "type": "string",
            "title": "Question"
          },
          "answer": {
            "type": "string",
            "title": "Answer"
          },
          "sources": {
            "items": {
              "$ref": "#/components/schemas/SourceDetail"
            },
            "type": "array",
            "title": "Sources"
          },
          "metrics": {
            "anyOf": [
              {
                "$ref": "#/components/schemas/EvaluationMetrics"
              },
              {
                "type": "null"
              }
            ]
          }
        },
        "type": "object",
        "required": [
          "question",
          "answer"
        ],
        "title": "EnhancedAskResponse",
        "description": "Enhanced response with detailed sources and metrics.\n\nUsed when enable_evaluation=True or for detailed citation display.\n\nAttributes:\n    question: Echo of the original question.\n    answer: The generated answer.\n    sources: Detailed source citations with snippets and scores.\n    metrics: Optional evaluation metrics (if enable_evaluation=True)."
      },
      "EvaluationMetrics": {
        "properties": {
          "faithfulness": {
            "$ref": "#/components/schemas/FaithfulnessLevel"
          },
          "confidence_score": {
            "type": "number",
            "maximum": 1.0,
            "minimum": 0.0,
            "title": "Confidence Score"
          },
          "evaluation_reason": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Evaluation Reason",
            "description": "評估結果說明"
          },
          "accuracy": {
            "anyOf": [
              {
                "type": "number",
                "maximum": 10.0,
                "minimum": 1.0
              },
              {
                "type": "null"
              }
            ],
            "title": "Accuracy",
            "description": "D1: 數據精確度 (1-10, 權重 50%)"
          },
          "completeness": {
            "anyOf": [
              {
                "type": "number",
                "maximum": 10.0,
                "minimum": 1.0
              },
              {
                "type": "null"
              }
            ],
            "title": "Completeness",
            "description": "D2: 完整覆蓋率 (1-10, 權重 30%)"
          },
          "clarity": {
            "anyOf": [
              {
                "type": "number",
                "maximum": 10.0,
                "minimum": 1.0
              },
              {
                "type": "null"
              }
            ],
            "title": "Clarity",
            "description": "D3: 邏輯表達 (1-10, 權重 20%)"
          },
          "weighted_score": {
            "anyOf": [
              {
                "type": "number",
                "maximum": 10.0,
                "minimum": 1.0
              },
              {
                "type": "null"
              }
            ],
            "title": "Weighted Score",
            "description": "加權總分 (0.5*acc + 0.3*cmp + 0.2*clr)"
          },
          "suggestion": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Suggestion",
            "description": "改進建議 (用於 Smart Retry)"
          },
          "is_passing": {
            "anyOf": [
              {
                "type": "boolean"
              },
              {
                "type": "null"
              }
            ],
            "title": "Is Passing",
            "description": "是否通過門檻 (accuracy >= 7)"
          }
        },
        "type": "object",
        "required": [
          "faithfulness",
          "confidence_score"
        ],
        "title": "EvaluationMetrics",
        "description": "Responsible AI metrics for answer quality.\n\nPhase 4 Academic Evaluation (1-10 scale):\n- accuracy: Data precision, citation correctness (50% weight)\n- completeness: Coverage of all sub-aspects (30% weight)\n- clarity: Logical structure and expression (20% weight)\n\nAttributes:\n    faithfulness: Legacy field - maps from accuracy score.\n    confidence_score: Overall confidence (0.0-1.0).\n    evaluation_reason: Detailed evaluation reasoning.\n    accuracy: D1 - Data precision score (1-10).\n    completeness: D2 - Coverage completeness (1-10).\n    clarity: D3 - Logical expression (1-10).\n    weighted_score: Weighted total (0.5*acc + 0.3*cmp + 0.2*clr).\n    suggestion: Improvement suggestion for retry.\n    is_passing: True if accuracy >= 7."
      },
      "ExecutePlanRequest": {
        "properties": {
          "original_question": {
            "type": "string",
            "title": "Original Question"
          },
          "sub_tasks": {
            "items": {
              "$ref": "#/components/schemas/EditableSubTask"
            },
            "type": "array",
            "title": "Sub Tasks"
          },
          "doc_ids": {
            "anyOf": [
              {
                "items": {
                  "type": "string"
                },
                "type": "array"
              },
              {
                "type": "null"
              }
            ],
            "title": "Doc Ids"
          },
          "max_iterations": {
            "type": "integer",
            "maximum": 5.0,
            "minimum": 1.0,
            "title": "Max Iterations",
            "default": 2
          },
          "enable_reranking": {
            "type": "boolean",
            "title": "Enable Reranking",
            "default": true
          },
          "enable_drilldown": {
            "type": "boolean",
            "title": "Enable Drilldown",
            "default": true
          },
          "enable_deep_image_analysis": {
            "type": "boolean",
            "title": "Enable Deep Image Analysis",
            "description": "啟用進階圖片查證（針對特定問題重新分析圖片，會增加 API 調用）",
            "default": false
          },
          "conversation_id": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Conversation Id"
          }
        },
        "type": "object",
        "required": [
          "original_question",
          "sub_tasks"
        ],
        "title": "ExecutePlanRequest",
        "description": "Request model for executing a confirmed research plan.\n\nAttributes:\n    original_question: The original research question.\n    sub_tasks: User-confirmed (possibly modified) sub-tasks.\n    doc_ids: Document IDs to restrict search scope.\n    max_iterations: Maximum drill-down iterations (1-5).\n    enable_reranking: Enable cross-encoder reranking.\n    enable_drilldown: Enable recursive drill-down for knowledge gaps.\n    enable_deep_image_analysis: Enable deep image analysis for specific questions.\n    conversation_id: Optional conversation ID to persist results to."
      },
      "ExecutePlanResponse": {
        "properties": {
          "question": {
            "type": "string",
            "title": "Question"
          },
          "summary": {
            "type": "string",
            "title": "Summary"
          },
          "detailed_answer": {
            "type": "string",
            "title": "Detailed Answer"
          },
          "sub_tasks": {
            "items": {
              "$ref": "#/components/schemas/SubTaskExecutionResult"
            },
            "type": "array",
            "title": "Sub Tasks"
          },
          "all_sources": {
            "items": {
              "type": "string"
            },
            "type": "array",
            "title": "All Sources"
          },
          "confidence": {
            "type": "number",
            "maximum": 1.0,
            "minimum": 0.0,
            "title": "Confidence"
          },
          "total_iterations": {
            "type": "integer",
            "title": "Total Iterations",
            "default": 0
          }
        },
        "type": "object",
        "required": [
          "question",
          "summary",
          "detailed_answer",
          "sub_tasks",
          "all_sources",
          "confidence"
        ],
        "title": "ExecutePlanResponse",
        "description": "Response model for research plan execution.\n\nAttributes:\n    question: Original research question.\n    summary: Executive summary of findings.\n    detailed_answer: Full research report.\n    sub_tasks: All executed sub-tasks (original + drill-down).\n    all_sources: Deduplicated list of all document sources.\n    confidence: Overall confidence score (0.0-1.0).\n    total_iterations: Number of drill-down iterations performed."
      },
      "ExtractedDocument": {
        "properties": {
          "doc_id": {
            "type": "string",
            "format": "uuid",
            "title": "Doc Id"
          },
          "user_id": {
            "type": "string",
            "title": "User Id"
          },
          "text_chunks": {
            "items": {
              "$ref": "#/components/schemas/TextChunk"
            },
            "type": "array",
            "title": "Text Chunks"
          },
          "visual_elements": {
            "items": {
              "$ref": "#/components/schemas/VisualElement"
            },
            "type": "array",
            "title": "Visual Elements"
          },
          "processed_at": {
            "type": "string",
            "format": "date-time",
            "title": "Processed At"
          }
        },
        "type": "object",
        "required": [
          "doc_id",
          "user_id",
          "text_chunks",
          "visual_elements"
        ],
        "title": "ExtractedDocument"
      },
      "FaithfulnessLevel": {
        "type": "string",
        "enum": [
          "grounded",
          "hallucinated",
          "uncertain",
          "evaluation_failed"
        ],
        "title": "FaithfulnessLevel",
        "description": "Faithfulness evaluation results."
      },
      "GraphOperationResponse": {
        "properties": {
          "status": {
            "type": "string",
            "title": "Status"
          },
          "message": {
            "type": "string",
            "title": "Message"
          },
          "details": {
            "anyOf": [
              {
                "additionalProperties": true,
                "type": "object"
              },
              {
                "type": "null"
              }
            ],
            "title": "Details"
          }
        },
        "type": "object",
        "required": [
          "status",
          "message"
        ],
        "title": "GraphOperationResponse",
        "description": "Response for graph operations."
      },
      "GraphOptimizeRequest": {
        "properties": {
          "regenerate_communities": {
            "type": "boolean",
            "title": "Regenerate Communities",
            "description": "重新生成社群摘要",
            "default": true
          }
        },
        "type": "object",
        "title": "GraphOptimizeRequest",
        "description": "Request for graph optimization."
      },
      "GraphRebuildRequest": {
        "properties": {
          "force": {
            "type": "boolean",
            "title": "Force",
            "description": "強制重建即使圖譜沒有變更",
            "default": false
          }
        },
        "type": "object",
        "title": "GraphRebuildRequest",
        "description": "Request for graph rebuild."
      },
      "GraphStatusResponse": {
        "properties": {
          "has_graph": {
            "type": "boolean",
            "title": "Has Graph",
            "description": "是否有圖譜"
          },
          "node_count": {
            "type": "integer",
            "title": "Node Count",
            "description": "節點數量",
            "default": 0
          },
          "edge_count": {
            "type": "integer",
            "title": "Edge Count",
            "description": "邊數量",
            "default": 0
          },
          "community_count": {
            "type": "integer",
            "title": "Community Count",
            "description": "社群數量",
            "default": 0
          },
          "pending_resolution": {
            "type": "integer",
            "title": "Pending Resolution",
            "description": "待融合實體數量",
            "default": 0
          },
          "needs_optimization": {
            "type": "boolean",
            "title": "Needs Optimization",
            "description": "是否需要優化",
            "default": false
          },
          "last_updated": {
            "anyOf": [
              {
                "type": "string",
                "format": "date-time"
              },
              {
                "type": "null"
              }
            ],
            "title": "Last Updated",
            "description": "最後更新時間"
          }
        },
        "type": "object",
        "required": [
          "has_graph"
        ],
        "title": "GraphStatusResponse",
        "description": "Response model for graph status API endpoint.\n\nProvides overview information about the user's knowledge graph.",
        "example": {
          "community_count": 12,
          "edge_count": 3400,
          "has_graph": true,
          "last_updated": "2025-12-21T10:30:00Z",
          "needs_optimization": true,
          "node_count": 1250,
          "pending_resolution": 45
        }
      },
      "GraphVisualizationData": {
        "properties": {
          "nodes": {
            "items": {
              "$ref": "#/components/schemas/VisNode"
            },
            "type": "array",
            "title": "Nodes"
          },
          "links": {
            "items": {
              "$ref": "#/components/schemas/VisLink"
            },
            "type": "array",
            "title": "Links"
          }
        },
        "type": "object",
        "title": "GraphVisualizationData",
        "description": "Response for graph visualization (react-force-graph format)."
      },
      "HTTPValidationError": {
        "properties": {
          "detail": {
            "items": {
              "$ref": "#/components/schemas/ValidationError"
            },
            "type": "array",
            "title": "Detail"
          }
        },
        "type": "object",
        "title": "HTTPValidationError"
      },
      "MessageCreate": {
        "properties": {
          "role": {
            "type": "string",
            "enum": [
              "user",
              "assistant",
              "system"
            ],
            "title": "Role"
          },
          "content": {
            "type": "string",
            "title": "Content"
          },
          "metadata": {
            "anyOf": [
              {
                "additionalProperties": true,
                "type": "object"
              },
              {
                "type": "null"
              }
            ],
            "title": "Metadata"
          }
        },
        "type": "object",
        "required": [
          "role",
          "content"
        ],
        "title": "MessageCreate",
        "description": "Request model for adding a new message to a conversation.\n\nAttributes:\n    role: Message role ('user', 'assistant', 'system').\n    content: Message content.\n    metadata: Optional metadata."
      },
      "MessageRole": {
        "type": "string",
        "enum": [
          "user",
          "assistant"
        ],
        "title": "MessageRole",
        "description": "Valid roles for chat messages in conversation history."
      },
      "ResearchPlanRequest": {
        "properties": {
          "question": {
            "type": "string",
            "maxLength": 2000,
            "minLength": 1,
            "title": "Question"
          },
          "doc_ids": {
            "anyOf": [
              {
                "items": {
                  "type": "string"
                },
                "type": "array"
              },
              {
                "type": "null"
              }
            ],
            "title": "Doc Ids"
          },
          "enable_graph_planning": {
            "type": "boolean",
            "title": "Enable Graph Planning",
            "default": false
          }
        },
        "type": "object",
        "required": [
          "question"
        ],
        "title": "ResearchPlanRequest",
        "description": "Request model for generating a research plan.\n\nAttributes:\n    question: The complex research question.\n    doc_ids: Optional document IDs to restrict search scope.\n    enable_graph_planning: Use graph-aware task planning prompts."
      },
      "ResearchPlanResponse": {
        "properties": {
          "status": {
            "type": "string",
            "const": "waiting_confirmation",
            "title": "Status",
            "default": "waiting_confirmation"
          },
          "original_question": {
            "type": "string",
            "title": "Original Question"
          },
          "sub_tasks": {
            "items": {
              "$ref": "#/components/schemas/EditableSubTask"
            },
            "type": "array",
            "title": "Sub Tasks"
          },
          "estimated_complexity": {
            "type": "string",
            "enum": [
              "simple",
              "medium",
              "complex"
            ],
            "title": "Estimated Complexity",
            "default": "medium"
          },
          "doc_ids": {
            "anyOf": [
              {
                "items": {
                  "type": "string"
                },
                "type": "array"
              },
              {
                "type": "null"
              }
            ],
            "title": "Doc Ids"
          }
        },
        "type": "object",
        "required": [
          "original_question",
          "sub_tasks"
        ],
        "title": "ResearchPlanResponse",
        "description": "Response model for research plan generation.\n\nReturned by POST /rag/plan for user confirmation.\n\nAttributes:\n    status: Always 'waiting_confirmation' to indicate pending user action.\n    original_question: The original question submitted.\n    sub_tasks: List of planned sub-tasks, editable by user.\n    estimated_complexity: Estimated complexity level.\n    doc_ids: Document IDs the research is scoped to."
      },
      "ResearchRequest": {
        "properties": {
          "question": {
            "type": "string",
            "title": "Question"
          },
          "max_subtasks": {
            "type": "integer",
            "title": "Max Subtasks",
            "default": 5
          },
          "enable_reranking": {
            "type": "boolean",
            "title": "Enable Reranking",
            "default": true
          },
          "enable_graph_planning": {
            "type": "boolean",
            "title": "Enable Graph Planning",
            "default": false
          }
        },
        "type": "object",
        "required": [
          "question"
        ],
        "title": "ResearchRequest",
        "description": "Request model for research queries."
      },
      "ResearchResponse": {
        "properties": {
          "question": {
            "type": "string",
            "title": "Question"
          },
          "summary": {
            "type": "string",
            "title": "Summary"
          },
          "detailed_answer": {
            "type": "string",
            "title": "Detailed Answer"
          },
          "sub_tasks": {
            "items": {
              "$ref": "#/components/schemas/SubTaskResponse"
            },
            "type": "array",
            "title": "Sub Tasks"
          },
          "all_sources": {
            "items": {
              "type": "string"
            },
            "type": "array",
            "title": "All Sources"
          },
          "confidence": {
            "type": "number",
            "title": "Confidence"
          }
        },
        "type": "object",
        "required": [
          "question",
          "summary",
          "detailed_answer",
          "sub_tasks",
          "all_sources",
          "confidence"
        ],
        "title": "ResearchResponse",
        "description": "Response model for research queries."
      },
      "SourceDetail": {
        "properties": {
          "doc_id": {
            "type": "string",
            "title": "Doc Id"
          },
          "filename": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Filename"
          },
          "page": {
            "anyOf": [
              {
                "type": "integer"
              },
              {
                "type": "null"
              }
            ],
            "title": "Page"
          },
          "snippet": {
            "type": "string",
            "title": "Snippet",
            "description": "引用段落原文 (前 200 字)"
          },
          "score": {
            "type": "number",
            "maximum": 1.0,
            "minimum": 0.0,
            "title": "Score",
            "description": "相關性分數"
          }
        },
        "type": "object",
        "required": [
          "doc_id",
          "snippet",
          "score"
        ],
        "title": "SourceDetail",
        "description": "Detailed source citation for RAG responses.\n\nAttributes:\n    doc_id: Document UUID.\n    filename: Display-friendly filename.\n    page: Page number (if available).\n    snippet: Relevant text excerpt (first 200 chars).\n    score: Relevance score from reranker."
      },
      "SubTaskExecutionResult": {
        "properties": {
          "id": {
            "type": "integer",
            "title": "Id"
          },
          "question": {
            "type": "string",
            "title": "Question"
          },
          "answer": {
            "type": "string",
            "title": "Answer"
          },
          "sources": {
            "items": {
              "type": "string"
            },
            "type": "array",
            "title": "Sources"
          },
          "contexts": {
            "items": {
              "type": "string"
            },
            "type": "array",
            "title": "Contexts"
          },
          "is_drilldown": {
            "type": "boolean",
            "title": "Is Drilldown",
            "default": false
          },
          "iteration": {
            "type": "integer",
            "title": "Iteration",
            "default": 0
          },
          "usage": {
            "additionalProperties": true,
            "type": "object",
            "title": "Usage"
          },
          "thought_process": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Thought Process"
          },
          "tool_calls": {
            "items": {
              "additionalProperties": true,
              "type": "object"
            },
            "type": "array",
            "title": "Tool Calls"
          }
        },
        "type": "object",
        "required": [
          "id",
          "question",
          "answer"
        ],
        "title": "SubTaskExecutionResult",
        "description": "Result from executing a single sub-task.\n\nAttributes:\n    id: Task identifier.\n    question: The question asked.\n    answer: The answer generated.\n    sources: Document IDs referenced.\n    contexts: Text chunks used for the answer.\n    is_drilldown: Whether this was a drill-down task.\n    iteration: Drill-down iteration (0 for original tasks).\n    usage: Token usage information.\n    thought_process: The agent's raw Chain of Thought.\n    tool_calls: Details of which tools were invoked."
      },
      "SubTaskResponse": {
        "properties": {
          "id": {
            "type": "integer",
            "title": "Id"
          },
          "question": {
            "type": "string",
            "title": "Question"
          },
          "answer": {
            "type": "string",
            "title": "Answer"
          },
          "sources": {
            "items": {
              "type": "string"
            },
            "type": "array",
            "title": "Sources"
          }
        },
        "type": "object",
        "required": [
          "id",
          "question",
          "answer"
        ],
        "title": "SubTaskResponse",
        "description": "Response for a single sub-task."
      },
      "TextChunk": {
        "properties": {
          "page_number": {
            "type": "integer",
            "title": "Page Number"
          },
          "content": {
            "type": "string",
            "title": "Content",
            "description": "Markdown formatted content"
          },
          "chunk_id": {
            "type": "string",
            "title": "Chunk Id"
          }
        },
        "type": "object",
        "required": [
          "page_number",
          "content",
          "chunk_id"
        ],
        "title": "TextChunk"
      },
      "UploadPdfResponse": {
        "properties": {
          "doc_id": {
            "type": "string",
            "title": "Doc Id",
            "description": "Document UUID"
          },
          "status": {
            "type": "string",
            "title": "Status",
            "description": "Document status in database"
          },
          "message": {
            "type": "string",
            "title": "Message",
            "description": "Human-readable upload result"
          },
          "pdf_available": {
            "type": "boolean",
            "title": "Pdf Available",
            "description": "Whether translated PDF is already available"
          },
          "pdf_download_url": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Pdf Download Url",
            "description": "Download URL when PDF is available"
          },
          "pdf_error": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Pdf Error",
            "description": "PDF generation error if generation failed"
          },
          "rag_status": {
            "type": "string",
            "title": "Rag Status",
            "description": "Background RAG post-processing status",
            "default": "processing_background"
          }
        },
        "type": "object",
        "required": [
          "doc_id",
          "status",
          "message",
          "pdf_available"
        ],
        "title": "UploadPdfResponse",
        "description": "Response model for PDF upload and processing kickoff."
      },
      "ValidationError": {
        "properties": {
          "loc": {
            "items": {
              "anyOf": [
                {
                  "type": "string"
                },
                {
                  "type": "integer"
                }
              ]
            },
            "type": "array",
            "title": "Location"
          },
          "msg": {
            "type": "string",
            "title": "Message"
          },
          "type": {
            "type": "string",
            "title": "Error Type"
          }
        },
        "type": "object",
        "required": [
          "loc",
          "msg",
          "type"
        ],
        "title": "ValidationError"
      },
      "VisLink": {
        "properties": {
          "source": {
            "type": "string",
            "title": "Source",
            "description": "來源節點 ID"
          },
          "target": {
            "type": "string",
            "title": "Target",
            "description": "目標節點 ID"
          },
          "label": {
            "type": "string",
            "title": "Label",
            "description": "關係標籤"
          }
        },
        "type": "object",
        "required": [
          "source",
          "target",
          "label"
        ],
        "title": "VisLink",
        "description": "Link for react-force-graph visualization."
      },
      "VisNode": {
        "properties": {
          "id": {
            "type": "string",
            "title": "Id",
            "description": "唯一節點識別碼（標籤）"
          },
          "group": {
            "type": "integer",
            "title": "Group",
            "description": "分群 ID（用於著色）"
          },
          "val": {
            "type": "integer",
            "title": "Val",
            "description": "節點大小（引用次數）"
          },
          "desc": {
            "type": "string",
            "title": "Desc",
            "description": "節點描述"
          }
        },
        "type": "object",
        "required": [
          "id",
          "group",
          "val",
          "desc"
        ],
        "title": "VisNode",
        "description": "Node for react-force-graph visualization."
      },
      "VisualElement": {
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "title": "Id"
          },
          "type": {
            "$ref": "#/components/schemas/VisualElementType"
          },
          "page_number": {
            "type": "integer",
            "title": "Page Number"
          },
          "image_path": {
            "type": "string",
            "title": "Image Path",
            "description": "Path to the cropped image"
          },
          "bbox": {
            "items": {
              "type": "integer"
            },
            "type": "array",
            "title": "Bbox",
            "description": "[x1, y1, x2, y2] coordinates"
          },
          "original_text": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Original Text"
          },
          "summary": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Summary",
            "description": "Gemini generated summary"
          },
          "context_text": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Context Text",
            "description": "周圍文字上下文（Caption + 前後文）"
          },
          "figure_reference": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Figure Reference",
            "description": "圖片引用標識，如 'Figure 1', '圖一'"
          }
        },
        "type": "object",
        "required": [
          "id",
          "type",
          "page_number",
          "image_path",
          "bbox"
        ],
        "title": "VisualElement"
      },
      "VisualElementType": {
        "type": "string",
        "enum": [
          "table",
          "figure",
          "formula"
        ],
        "title": "VisualElementType"
      }
    },
    "securitySchemes": {
      "HTTPBearer": {
        "type": "http",
        "scheme": "bearer"
      }
    }
  }
}